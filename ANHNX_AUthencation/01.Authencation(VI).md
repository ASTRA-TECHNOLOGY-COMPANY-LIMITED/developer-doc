# Authentication - Xác thực

Authentication (Xác thực) là quá trình xác định xem một người dùng hay một ứng dụng có quyền truy cập vào các tài nguyên, chức năng hoặc dịch vụ cụ thể hay không. Trong lĩnh vực phát triển ứng dụng web và ứng dụng di động, Authentication là một khái niệm quan trọng để đảm bảo tính bảo mật và riêng tư trong việc quản lý thông tin người dùng và giới hạn quyền truy cập.

## Các bước trong quá trình Authentication

1. **User Registration (Đăng ký người dùng):** Người dùng cung cấp thông tin cá nhân và chọn một tên người dùng và mật khẩu để tạo tài khoản.

### Thông tin cá nhân

Người dùng cần cung cấp một số thông tin cá nhân cần thiết để tạo tài khoản. Thông tin này thường bao gồm:

- **Họ và tên:** Tên đầy đủ của người dùng.
- **Địa chỉ email:** Địa chỉ email hợp lệ, sẽ được sử dụng để liên lạc và xác nhận tài khoản.
- **Ngày sinh:** Ngày , tháng và năm sinh của người dùng.
- **Giới tính:** Thông tin về giới tính của người dùng (tuỳ chọn).
- **Các thông tin khác:** Một số ứng dụng có thể yêu cầu thêm thông tin như số điện thoại, địa chỉ, quốc gia, v.v.

### Tạo tên người dùng và mật khẩu

Sau khi cung cấp thông tin cá nhân, người dùng sẽ chọn một tên người dùng duy nhất và mật khẩu bảo mật cho tài khoản của mình. Tên người dùng là thông tin mà người dùng sẽ sử dụng để đăng nhập vào ứng dụng sau này. Mật khẩu nên được bảo mật và không nên được chia sẻ với bất kỳ ai khác.

### Xác nhận và hoàn tất

Sau khi điền đầy đủ thông tin và chọn tên người dùng cùng mật khẩu, người dùng sẽ hoàn tất quá trình đăng ký bằng cách nhấn nút "Đăng ký" hoặc tương tự trên giao diện ứng dụng. Sau đó, hệ thống sẽ xác minh thông tin và tạo một tài khoản mới cho người dùng. Thông thường, một email xác nhận có thể được gửi đến địa chỉ email đã cung cấp để xác nhận việc đăng ký và kích hoạt tài khoản.

Bước này rất quan trọng để ứng dụng có thể xác định và phân biệt mỗi người dùng riêng biệt và quản lý thông tin của họ. Việc đảm bảo tính bảo mật và an toàn trong việc lưu trữ thông tin người dùng và quá trình đăng ký là điều cần thiết để xây dựng một hệ thống Authentication (Xác thực) đáng tin cậy.

## Login (Đăng nhập)

Sau khi người dùng đã đăng ký tài khoản, bước tiếp theo là đăng nhập vào hệ thống. Trong bước này, người dùng sẽ nhập tên người dùng và mật khẩu đã đăng ký trước đó để xác thực danh tính của mình và truy cập vào các tài nguyên và chức năng của ứng dụng.

### Xác thực danh tính

Khi người dùng nhập tên người dùng và mật khẩu vào mẫu đăng nhập, hệ thống sẽ thực hiện quá trình xác thực danh tính như sau:

```javascript
function login(username, password) {
  // Kiểm tra xem tên người dùng có tồn tại trong cơ sở dữ liệu hay không
  if (username in database) {
    // Nếu tồn tại, so sánh mật khẩu đã nhập với mật khẩu trong cơ sở dữ liệu
    if (password === database[username].password) {
      return true; // Xác thực thành công
    } else {
      return false; // Sai mật khẩu
    }
  } else {
    return false; // Tên người dùng không tồn tại trong cơ sở dữ liệu
  }
}

    Ví dụ
    Giả sử người dùng có tài khoản đã đăng ký với các thông tin sau:

    Khi người dùng muốn đăng nhập vào hệ thống, họ sẽ nhập các thông tin này vào mẫu đăng nhập. Hệ thống sẽ thực hiện các bước xác thực như sau:
const usernameInput = Nguyet_truong;
const passwordInput = 123456;

if (login(usernameInput, passwordInput)) {
  console.log("Đăng nhập thành công!");
} else {
  console.log("Đăng nhập thất bại. Sai tên người dùng hoặc mật khẩu.");
}

```

3. **Authentication Token (Mã thông báo xác thực):** Sau khi người dùng đăng nhập thành công, hệ thống sẽ cấp một mã thông báo xác thực (authentication token) cho người dùng. Mã thông báo này thường được lưu trữ trong cookie hoặc Local Storage của trình duyệt để giữ cho người dùng đăng nhập khi duyệt web.

# Quá trình Đăng nhập và Duy trì đăng nhập thông qua Token

Quá trình đăng nhập và duy trì đăng nhập thông qua token là một phần quan trọng của nhiều ứng dụng web và di động hiện đại. Dưới đây là một hướng dẫn cơ bản về cách thực hiện quá trình này:

## Đăng nhập:

1. Khi người dùng cung cấp thông tin đăng nhập (tên người dùng và mật khẩu), gửi yêu cầu POST đến API backend với thông tin đăng nhập.
2. Backend kiểm tra thông tin đăng nhập, nếu hợp lệ, tạo ra một JWT (JSON Web Token) chứa các thông tin như ID người dùng, vai trò, thời gian hết hạn, v.v.
3. Trả về JWT cho client (frontend), frontend lưu trữ JWT (thường trong localStorage hoặc cookies) để sử dụng cho các yêu cầu sau này.

## Duy trì đăng nhập:

1. Sau khi đăng nhập thành công, JWT sẽ được gửi cùng với mỗi yêu cầu từ frontend đến backend.
2. Backend kiểm tra tính hợp lệ của JWT, nếu hợp lệ, thực hiện các yêu cầu mà người dùng yêu cầu.
3. Để đảm bảo tính bảo mật, JWT thường có một thời gian hết hạn. Nếu JWT hết hạn, người dùng sẽ phải đăng nhập lại để nhận một JWT mới.

## Refresh Token:

1. Để tránh việc người dùng phải đăng nhập lại sau khi JWT hết hạn, một cơ chế là Refresh Token được sử dụng.
2. Refresh Token là một token khác được trả về cùng với JWT sau khi đăng nhập thành công.
3. Khi JWT hết hạn, người dùng gửi Refresh Token đến backend để đổi lấy một JWT mới.
4. Refresh Token thường có thời hạn sống lâu hơn, và được lưu trữ an toàn hơn (ví dụ, HttpOnly cookies).

<!-- Refresh Token -->

# Quy trình Sử dụng JWT và Refresh Token

Trong việc quản lý xác thực và truy cập, JWT (JSON Web Token) cùng với Refresh Token đã được sử dụng để cải thiện quy trình như sau:

1. **Xác thực bằng Tên người dùng và Mật khẩu**
   Client sử dụng Tên người dùng và Mật khẩu để xác thực tại server.

2. **Tạo Token và Refresh Token**
   server tạo Token JWT với thời gian hiệu lực ngắn (ví dụ: 10 phút) và Refresh Token với thời gian hiệu lực dài hơn (ví dụ: 7 ngày).

3. **Sử dụng Token cho Yêu cầu Xác thực**
   Khi server truy cập giao diện yêu cầu xác thực, nó sẽ gửi Token kèm theo yêu cầu.

4. **Xác thực và Trả về Dữ liệu**
   Nếu Token vẫn còn hiệu lực, server sẽ xác thực và trả về dữ liệu yêu cầu của clinet sau khi xác thực.

5. **Áp dụng Refresh Token khi Token hết hạn**
   Nếu xác thực thất bại (ví dụ: trả về lỗi 401), client sử dụng Refresh Token để yêu cầu một Token mới từ máy chủ.

6. **Cấp Token mới cho Máy khách**
   Nếu Refresh Token vẫn còn hiệu lực, máy chủ sẽ cấp một Token mới cho máy khách.

7. **Sử dụng Token mới cho Truy cập**
   clinent sử dụng Token mới để truy cập giao diện yêu cầu xác thực.

Nhìn sơ qua, ta có thể thấy cách hoạt động của Refresh Token khác hoàn toàn so với Token thường. Quy trình này giúp tăng tính bảo mật và quản lý xác thực hiệu quả hơn trong ứng dụng.

# Lưu trữ Refresh Token

Khác với việc lưu trữ Token JWT ở Cookies, Session, hay localStorage tại máy khách, Refresh Token thường được lưu trữ ở phía máy chủ (server-side), thường là trong cơ sở dữ liệu. Điều này có nhiều lý do liên quan đến tính bảo mật và việc sử dụng Refresh Token:

- **Dữ liệu Nhạy cảm**: Refresh Token chứa thông tin nhạy cảm và quan trọng, dùng để tạo lại các access token. Lưu trữ nó tại máy chủ giúp đảm bảo rằng dữ liệu này không bị tiết lộ tới máy khách.

- **Quản lý An toàn**: Bằng cách lưu trữ Refresh Token tại máy chủ, bạn có thể thực hiện các biện pháp bảo mật như mã hóa, xác thực, kiểm tra và theo dõi Refresh Token một cách an toàn hơn.

- **Hiệu suất**: Refresh Token không thường xuyên được sử dụng và chỉ được kích hoạt khi access token hết hạn. Điều này không ảnh hưởng đến hiệu suất của database hay quá trình phản hồi từng yêu cầu từ máy khách.

Trong quá trình xây dựng hệ thống xác thực, quyết định lưu trữ Refresh Token ở phía server là một biện pháp thích hợp để tăng tính bảo mật và quản lý hiệu quả trong việc làm mới xác thực.

## Đăng xuất:

1. Để đăng xuất, bạn chỉ cần xóa JWT và Refresh Token khỏi bộ nhớ của người dùng (ví dụ: xóa khỏi localStorage hoặc hết hạn cookie).

## Bảo mật:

1. Đảm bảo JWT được ký số để ngăn sửa đổi không hợp lệ.
2. Sử dụng HTTPS thay vì HTTP để đảm bảo dữ liệu được truyền tải an toàn.
3. Để bảo mật Refresh Token, sử dụng HttpOnly cookies để lưu trữ nó và cấu hình cơ chế CORS cẩn thận.

4. **Logout (Đăng xuất):** Khi người dùng muốn kết thúc phiên làm việc, họ có thể đăng xuất khỏi tài khoản của mình. Khi đăng xuất, mã thông báo xác thực sẽ bị hủy bỏ và người dùng sẽ không thể truy cập vào các tài nguyên hoặc chức năng của ứng dụng.

### Giải thích

Quá trình đăng xuất là quá trình mà người dùng chấm dứt phiên làm việc hiện tại. Khi người dùng đăng xuất, hệ thống sẽ **hủy bỏ mã thông báo xác thực** (authentication token) mà người dùng đã nhận khi đăng nhập. Điều này có nghĩa là mã thông báo xác thực sẽ không còn có hiệu lực và người dùng sẽ **không thể truy cập vào bất kỳ tài nguyên hoặc chức năng nào** trong ứng dụng.

Thường, trong quá trình đăng xuất, hệ thống sẽ **xóa mã thông báo xác thực** từ **cookie** hoặc **Local Storage** của trình duyệt để đảm bảo không có thông tin xác thực được lưu trữ lại. Sau khi đăng xuất, người dùng có thể tiếp tục sử dụng ứng dụng nhưng sẽ được yêu cầu đăng nhập lại để tạo phiên làm việc mới.

### Ví dụ

Dưới đây là một ví dụ về cách thực hiện quá trình đăng xuất sử dụng mã thông báo xác thực trong JavaScript:

```javascript
// Hàm để thực hiện quá trình đăng xuất
function logout() {
  // Xóa mã thông báo xác thực từ Local Storage hoặc cookie (tùy chọn)
  localStorage.removeItem("authToken"); // Xóa mã thông báo từ Local Storage

  // Chuyển hướng người dùng đến trang đăng nhập sau khi đăng xuất
  window.location.href = "/login";
}
```
